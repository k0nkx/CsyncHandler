
if _G.CSync then
    _G.CSync.CsyncStop() -- Clean up any existing instance
    _G.CSync = nil
end

-- Services
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local CoreGui = game:GetService("CoreGui")
local Stats = game:GetService("Stats")

_G.CSync = {
    -- Public API Functions
    CsyncWorldPos = function(x, y, z) end,
    CsyncPos = function(x, y, z) end,
    CsyncStop = function() end,
    GetStatus = function() end,
    SetConfig = function(newConfig) end
}

local CSyncInternal = {
    Enabled = false,
    Connections = {},
    Instances = {},
    Drawings = {},
    PositionHistory = {},
    OriginalCFrameIndex = nil,
    Mode = "Relative",
    CurrentPosition = Vector3.new(0, 0, 0),
    
    Config = {
        UseServerPrediction = true,
        ServerPrediction = {
            HistoryDuration = 2,
            MaxPing = 300,
            HighPingThreshold = 160,
            HighPingReduction = 0.9
        },
        Visuals = {
            DesyncColor = Color3.fromRGB(0, 162, 255),
            Transparency = 0,
            ShowLine = true,
            Line = {
                MainColor = Color3.fromRGB(255, 255, 255),
                OutlineColor = Color3.fromRGB(0, 0, 0),
                MainThickness = 2,
                OutlineThickness = 3,
                MainTransparency = 1,
                OutlineTransparency = 1,
                Extension = 1
            },
            VisualType = "Both",
            MeshId = "rbxassetid://14123716423",
            MeshScale = Vector3.new(0.1, 0.1, 0.1),
            MeshOffset = Vector3.new(0, -0.8, 0),
            ImageId = "rbxassetid://94277058488615",
            ImageScale = 0.38,
            Highlight = {
                Enabled = true,
                FillColor = Color3.fromRGB(245, 173, 255),
                OutlineColor = Color3.fromRGB(255, 255, 255),
                FillTransparency = 0.7,
                OutlineTransparency = 0.5,
                DepthMode = "AlwaysOnTop"
            }
        }
    }
}

local player = Players.LocalPlayer
local playerCharacter = player.Character or player.CharacterAdded:Wait()
local playerHumanoid = playerCharacter:WaitForChild("Humanoid")
local playerHumanoidRootPart = playerCharacter:WaitForChild("HumanoidRootPart")
local playerHumanoidRootPartCFrame = nil

local function cleanup()
    CSyncInternal.Enabled = false
    
    for _, connection in pairs(CSyncInternal.Connections) do 
        if connection and typeof(connection) == "RBXScriptConnection" then 
            connection:Disconnect() 
        end
    end
    
    for _, instance in pairs(CSyncInternal.Instances) do
        if instance and instance.Parent then 
            instance:Destroy() 
        end
    end
    
    for _, drawing in pairs(CSyncInternal.Drawings) do
        if drawing then 
            drawing:Remove() 
        end
    end
    
    table.clear(CSyncInternal.Connections)
    table.clear(CSyncInternal.Instances)
    table.clear(CSyncInternal.Drawings)
    table.clear(CSyncInternal.PositionHistory)
    
    if CSyncInternal.OriginalCFrameIndex then
        hookmetamethod(game, "__index", CSyncInternal.OriginalCFrameIndex)
        CSyncInternal.OriginalCFrameIndex = nil
    end
end

local function getPing()
    local networkPing = player:GetNetworkPing() * 1000
    
    local dataPing = 0
    local item = Stats.Network.ServerStatsItem:FindFirstChild("Data Ping")
    if item then
        local ok, v = pcall(function()
            return item:GetValueString()
        end)
        if ok and v then
            dataPing = tonumber(v:match("%d+")) or 0
        end
    end
    
    local totalPing = networkPing + dataPing
    
    if totalPing > CSyncInternal.Config.ServerPrediction.HighPingThreshold then
        networkPing = networkPing * CSyncInternal.Config.ServerPrediction.HighPingReduction
        totalPing = networkPing + dataPing
    end
    
    return math.min(totalPing, CSyncInternal.Config.ServerPrediction.MaxPing)
end

local function getPredictedServerPosition()
    if not CSyncInternal.Config.UseServerPrediction then
        return playerHumanoidRootPart.Position
    end
    
    local currentTime = tick()
    CSyncInternal.PositionHistory[currentTime] = {
        Position = playerHumanoidRootPart.Position,
        Rotation = playerHumanoidRootPart.Rotation
    }
    
    for time in pairs(CSyncInternal.PositionHistory) do
        if currentTime - time > CSyncInternal.Config.ServerPrediction.HistoryDuration then
            CSyncInternal.PositionHistory[time] = nil
        end
    end
    
    local ping = getPing()
    local backtrackTime = currentTime - (ping / 1000)
    
    local closestTime = nil
    local smallestDiff = math.huge
    
    for time, data in pairs(CSyncInternal.PositionHistory) do
        local diff = math.abs(time - backtrackTime)
        if diff < smallestDiff then
            smallestDiff = diff
            closestTime = time
        end
    end
    
    if closestTime and CSyncInternal.PositionHistory[closestTime] then
        return CSyncInternal.PositionHistory[closestTime].Position
    end
    
    return playerHumanoidRootPart.Position
end

local function createVisuals()
    if CSyncInternal.Instances.desyncVisual then 
        CSyncInternal.Instances.desyncVisual:Destroy() 
    end
    
    if CSyncInternal.Instances.imageGui then
        CSyncInternal.Instances.imageGui:Destroy()
    end
    
    if CSyncInternal.Drawings.line then
        CSyncInternal.Drawings.line:Remove()
    end
    
    if CSyncInternal.Drawings.lineOutline then
        CSyncInternal.Drawings.lineOutline:Remove()
    end

    if not CSyncInternal.Enabled then return end

    local randomNum = math.random(222, 4444)
    local visualType = CSyncInternal.Config.Visuals.VisualType
    
    local desyncVisual = nil
    
    if visualType == "Mesh" or visualType == "Both" then
        desyncVisual = Instance.new("Part")
        desyncVisual.Name = "DesyVis_Mesh_" .. randomNum
        desyncVisual.Size = Vector3.new(0.1, 0.1, 0.1)
        desyncVisual.Color = CSyncInternal.Config.Visuals.DesyncColor
        desyncVisual.Material = Enum.Material.Neon
        desyncVisual.Transparency = CSyncInternal.Config.Visuals.Transparency
        desyncVisual.Anchored = true
        desyncVisual.CanCollide = false
        desyncVisual.CastShadow = false
        
        local specialMesh = Instance.new("SpecialMesh")
        specialMesh.MeshId = CSyncInternal.Config.Visuals.MeshId
        specialMesh.TextureId = "rbxassetid://14123716537"
        specialMesh.Scale = CSyncInternal.Config.Visuals.MeshScale
        specialMesh.Offset = CSyncInternal.Config.Visuals.MeshOffset
        specialMesh.MeshType = Enum.MeshType.FileMesh
        specialMesh.Parent = desyncVisual
        
        if CSyncInternal.Config.Visuals.Highlight.Enabled then
            local highlight = Instance.new("Highlight")
            highlight.Name = "DesyncHighlight"
            highlight.FillColor = CSyncInternal.Config.Visuals.Highlight.FillColor
            highlight.OutlineColor = CSyncInternal.Config.Visuals.Highlight.OutlineColor
            highlight.FillTransparency = CSyncInternal.Config.Visuals.Highlight.FillTransparency
            highlight.OutlineTransparency = CSyncInternal.Config.Visuals.Highlight.OutlineTransparency
            
            if CSyncInternal.Config.Visuals.Highlight.DepthMode == "AlwaysOnTop" then
                highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            else
                highlight.DepthMode = Enum.HighlightDepthMode.Occluded
            end
            
            highlight.Parent = desyncVisual
            CSyncInternal.Instances.highlight = highlight
        end

        desyncVisual.Parent = workspace
        CSyncInternal.Instances.desyncVisual = desyncVisual
        CSyncInternal.Instances.specialMesh = specialMesh
    end
    
    if visualType == "Image" or visualType == "Both" then
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "DesVisUI_" .. randomNum
        screenGui.ResetOnSpawn = false
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        local frame = Instance.new("Frame")
        frame.Name = "ImageContainer"
        frame.Size = UDim2.new(0, 100 * CSyncInternal.Config.Visuals.ImageScale, 
                                0, 100 * CSyncInternal.Config.Visuals.ImageScale)
        frame.BackgroundTransparency = 1
        frame.AnchorPoint = Vector2.new(0.5, 0.5)
        frame.Parent = screenGui
        
        local imageLabel = Instance.new("ImageLabel")
        imageLabel.Name = "DesyncImage"
        imageLabel.Size = UDim2.new(1, 0, 1, 0)
        imageLabel.Position = UDim2.new(0.5, 0, 0.5, 0)
        imageLabel.AnchorPoint = Vector2.new(0.5, 0.5)
        imageLabel.BackgroundTransparency = 1
        imageLabel.Image = CSyncInternal.Config.Visuals.ImageId
        imageLabel.ScaleType = Enum.ScaleType.Fit
        imageLabel.Parent = frame
        
        screenGui.Parent = CoreGui
        
        CSyncInternal.Instances.imageGui = screenGui
        CSyncInternal.Instances.imageFrame = frame
        CSyncInternal.Instances.imageLabel = imageLabel
    end

    if CSyncInternal.Config.Visuals.ShowLine then
        local lineOutline = Drawing.new("Line")
        lineOutline.Thickness = CSyncInternal.Config.Visuals.Line.OutlineThickness
        lineOutline.Color = CSyncInternal.Config.Visuals.Line.OutlineColor
        lineOutline.Transparency = CSyncInternal.Config.Visuals.Line.OutlineTransparency
        lineOutline.Visible = true
        
        local line = Drawing.new("Line")
        line.Thickness = CSyncInternal.Config.Visuals.Line.MainThickness
        line.Color = CSyncInternal.Config.Visuals.Line.MainColor
        line.Transparency = CSyncInternal.Config.Visuals.Line.MainTransparency
        line.Visible = true
        
        CSyncInternal.Drawings.lineOutline = lineOutline
        CSyncInternal.Drawings.line = line
    end
    
    return true
end

local function updateLines()
    if not CSyncInternal.Config.Visuals.ShowLine then 
        if CSyncInternal.Drawings.line then
            CSyncInternal.Drawings.line.Visible = false
        end
        if CSyncInternal.Drawings.lineOutline then
            CSyncInternal.Drawings.lineOutline.Visible = false
        end
        return 
    end
    
    if not CSyncInternal.Drawings.line or not CSyncInternal.Drawings.lineOutline then return end
    
    local line = CSyncInternal.Drawings.line
    local lineOutline = CSyncInternal.Drawings.lineOutline
    
    local visualExists = false
    local visualPosition = nil
    
    if CSyncInternal.Instances.desyncVisual then
        visualExists = true
        visualPosition = CSyncInternal.Instances.desyncVisual.Position
    end
    
    if CSyncInternal.Enabled and playerHumanoidRootPart and visualExists then
        local realPos = playerHumanoidRootPart.Position
        
        local realScreenPos, realVisible = Camera:WorldToViewportPoint(realPos)
        local desyncScreenPos, desyncVisible = Camera:WorldToViewportPoint(visualPosition)
        
        if realVisible and desyncVisible then
            local fromPos = Vector2.new(realScreenPos.X, realScreenPos.Y)
            local toPos = Vector2.new(desyncScreenPos.X, desyncScreenPos.Y)
            
            local direction = (toPos - fromPos)
            local length = direction.Magnitude
            
            if length > 0 then
                local normalizedDir = direction / length
                local extension = CSyncInternal.Config.Visuals.Line.Extension
                local outlineFrom = fromPos - (normalizedDir * extension)
                local outlineTo = toPos + (normalizedDir * extension)
                
                lineOutline.From = outlineFrom
                lineOutline.To = outlineTo
                lineOutline.Visible = true
                
                line.From = fromPos
                line.To = toPos
                line.Visible = true
            else
                lineOutline.Visible = false
                line.Visible = false
            end
        else
            lineOutline.Visible = false
            line.Visible = false
        end
    else
        lineOutline.Visible = false
        line.Visible = false
    end
end

local function updateImagePosition()
    if not CSyncInternal.Enabled then return end
    if not CSyncInternal.Instances.imageGui then return end
    if not CSyncInternal.Instances.desyncVisual then return end
    
    local desyncPos = CSyncInternal.Instances.desyncVisual.Position
    local screenPoint = Camera:WorldToScreenPoint(desyncPos)
    
    CSyncInternal.Instances.imageFrame.Position = UDim2.new(0, screenPoint.X, 0, screenPoint.Y)
end

local function setupConnections()
    cleanup()
    
    CSyncInternal.Connections.characterAdded = player.CharacterAdded:Connect(function(NewCharacter)
        playerCharacter = NewCharacter
        playerHumanoid = playerCharacter:WaitForChild("Humanoid")
        playerHumanoidRootPart = playerCharacter:WaitForChild("HumanoidRootPart")
        
        if CSyncInternal.Enabled then
            createVisuals()
        end
    end)
    
    CSyncInternal.Connections.inputBegan = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.V then
            if CSyncInternal.Enabled then
                _G.CSync.CsyncStop()
            else
                if CSyncInternal.Mode == "World" then
                    _G.CSync.CsyncWorldPos(CSyncInternal.CurrentPosition.X, CSyncInternal.CurrentPosition.Y, CSyncInternal.CurrentPosition.Z)
                else
                    _G.CSync.CsyncPos(CSyncInternal.CurrentPosition.X, CSyncInternal.CurrentPosition.Y, CSyncInternal.CurrentPosition.Z)
                end
            end
        end
    end)
    
    CSyncInternal.Connections.heartbeat = RunService.Heartbeat:Connect(function(deltaTime)
        if playerCharacter and playerHumanoidRootPart then
            playerHumanoidRootPartCFrame = playerHumanoidRootPart.CFrame
            
            local basePosition = getPredictedServerPosition()
            
            local desyncedPosition
            if CSyncInternal.Mode == "World" then
                desyncedPosition = CSyncInternal.CurrentPosition
            else
                desyncedPosition = basePosition + CSyncInternal.CurrentPosition
            end
            
            if CSyncInternal.Instances.desyncVisual then
                CSyncInternal.Instances.desyncVisual.CFrame = CFrame.new(desyncedPosition) * playerHumanoidRootPart.CFrame.Rotation
            end
            
            playerHumanoidRootPart.CFrame = CFrame.new(desyncedPosition) * playerHumanoidRootPart.CFrame.Rotation
            RunService.RenderStepped:Wait()
            playerHumanoidRootPart.CFrame = playerHumanoidRootPartCFrame
            playerHumanoidRootPartCFrame = playerHumanoidRootPart.CFrame
        end
    end)
    
    CSyncInternal.Connections.renderStepped = RunService.RenderStepped:Connect(function()
        updateLines()
        updateImagePosition()
    end)
    
    CSyncInternal.OriginalCFrameIndex = hookmetamethod(game, "__index", function(Instance, Property)
        if playerCharacter and playerHumanoidRootPart and Instance == playerHumanoidRootPart and Property == "CFrame" then
            if not checkcaller() then
                return playerHumanoidRootPartCFrame
            end
        end
        return CSyncInternal.OriginalCFrameIndex(Instance, Property)
    end)
end

_G.CSync.CsyncWorldPos = function(x, y, z)
    CSyncInternal.Enabled = true
    CSyncInternal.Mode = "World"
    CSyncInternal.CurrentPosition = Vector3.new(x, y, z)
    
    setupConnections()
    createVisuals()
    
    return true
end

_G.CSync.CsyncPos = function(x, y, z)
    CSyncInternal.Enabled = true
    CSyncInternal.Mode = "Relative"
    CSyncInternal.CurrentPosition = Vector3.new(x, y, z)
    
    setupConnections()
    createVisuals()
    
    return true
end

_G.CSync.CsyncStop = function()
    CSyncInternal.Enabled = false
    cleanup()
    return true
end

_G.CSync.GetStatus = function()
    return {
        Enabled = CSyncInternal.Enabled,
        Mode = CSyncInternal.Mode,
        Position = CSyncInternal.CurrentPosition,
        Config = CSyncInternal.Config
    }
end

_G.CSync.SetConfig = function(newConfig)
    for key, value in pairs(newConfig) do
        if CSyncInternal.Config[key] ~= nil then
            if typeof(value) == "table" then
                for subKey, subValue in pairs(value) do
                    if CSyncInternal.Config[key][subKey] ~= nil then
                        CSyncInternal.Config[key][subKey] = subValue
                    end
                end
            else
                CSyncInternal.Config[key] = value
            end
        end
    end
    
    if CSyncInternal.Enabled then
        createVisuals()
    end
    
    print("[CSync] Configuration updated")
    return true
end

setupConnections()

return _G.CSync
